/*
 * Defines the routes for the Server.
 * @author Ron Ammar
 */

var express= require("express");
var ga4ghRequests= require("./ga4gh-requests");
var bodyParser= require("body-parser");
var uploader= require("jquery-file-upload-middleware");
var fs=require('fs');
var dbConstant= require("./mongodb_constants");
var nodeConstant= require("./node_constants"); 
var annotateFile = require('../scripts/annotateAndAddVariants'); 



var getRouter= express.Router();
getRouter.use(function(request, response) {
	var promise;

	if (request.baseUrl == "/datasets") {
		promise= ga4ghRequests.getProjects();
	}

	promise.then(function(result) {
		// Currently, I'm not paying attention to the next page token because
		// it doesn't always appear. If it ever does, write an error to console
		// so that it is brought to my attention.
		if (result.nextPageToken !== undefined) {
			console.log("ERROR: nextPageToken found, not managed.");
		}

		response.send(result);
	}, function(err) {
		console.log(err);
	});
});

var postRouter= express.Router();
postRouter.use(bodyParser.json());
postRouter.use(function(request, response) {
	var promise;

	if (request.baseUrl == "/callsets/search") {
		promise= ga4ghRequests.getPatients(request.body);
	} else if (request.baseUrl == "/variants/search") {
		promise = ga4ghRequests.getVariants(request.body);
	}
	promise.then(function(result) {
		response.send(result);
	}, function(err) {
		console.log(err);
	});
});




/* jquery-file-upload-middlware routs
 * The jquery file upload middleware handles the bulf ot the work when it comes to the file
 * Upload. The jquery-file-upload plugin emits an ajax call and then the middleware handles 
 * the response. It has automatic event handlers for listeing to cancellations (aka aborts)
 * and failures. In these scenarios it will automatically delete the incomplete file.
 * additionally it also has handlers for file success and file download
*/


//Configure the uploader to tell it what directories to use
uploader.configure({
	tmpDir:nodeConstant.TMP_UPLOAD_DIR,
	uploadDir:nodeConstant.VCF_UPLOAD_DIR,
	uploadUrl:'/upload/vcf'
});


/* Event Handler that is triggered upon successful completion of the file upload
 * This handler facilitates the addition of annotation information adn the inclusion
 * of the vcf file into the local database
*/
uploader.on('end',function(fileInfo,req,res){
	var inputPath = nodeConstant.VCF_UPLOAD_DIR + "/" +fileInfo.name;
	inputPath = inputPath.replace(/\s+/g,"_"); //for windows applications remove potential spaces in names
	inputPath = inputPath.replace(/\(|\)/g,""); //for windows applications remove brackets in names
	fs.renameSync(nodeConstant.VCF_UPLOAD_DIR + '/' + fileInfo.name,inputPath); //rename the input file
	var ouputPath = inputPath + '.json';
	var patientOptions = {};
	//parse additional form options that were passed with the file
	for (var property in req.fields){
		if (req.fields.hasOwnProperty(property)){
			if (!(req.fields[property] == "")){
				switch(property)
				{
					case 'age':
						patientOptions[property] = parseInt(req.fields[property],10);
						break;
					case 'sex':
						patientOptions[property] = req.fields[property].toLowerCase();
						break;
					//For future use, if there are additional fields added. Validation should be done on
					//THe form itself. not here
					default:
						patientOptions[property] = req.fields[property];
						break;
				}
			}
		}
	}

	//Add the new patient to the database assigning it unique table
	dbFunctions.addPatient(patientOptions)
	.then(function(patient_variant_table){
		//annotate and Add the file to the running server
		return annotateFile({
			input:inputPath,
			output:ouputPath,
			table:patient_variant_table,
			annovarpath:nodeConstant.DEFAULT_ANNOVAR_PATH, //Set to some constant Value
			annodb:nodeConstant.DEFAULT_ANNOVAR_ANNO,
			dbusage:nodeConstant.DEFAULT_ANNOVAR_USAGE
		});
		
	}).then(function(){
		fs.unlink(inputPath); //remove the input file after being inputted to the mongo db
	})
	.catch(function(err){ // catch any errors taht arise
		return dbFunctions.removePatient(patientOptions) //remove the patient. *IMPORTANT* THIS DOES NOT decrement the number
		.then(function(){
			fs.unlink(inputPath);
		})
		.catch(function(err){
			console.log(err);
		})
	});
});


//Main uploader Route function
var uploadRouter = express.Router();
uploadRouter.use(uploader.fileHandler());

//get Patient identifiers for autocompletion and field validation
var getPatients = express.Router();
getPatients.use(bodyParser.json());
getPatients.use(function(request,response){
	var promise;
	if (request.baseUrl == "/database/getPatients"){
		promise = dbFunctions.findAllPatients();
	}
	promise.then(function(result){
		response.send(result)
	}).catch(function(err){
		console.log(err.toString())
	});

});


exports.getRouter= getRouter;
exports.postRouter= postRouter;
exports.uploadRouter = uploadRouter;
exports.getPatients = getPatients;



